name: UI Tests

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  workflow_dispatch:
jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      checks: write
      pull-requests: write
    environment: 
      name: ${{ github.ref == 'refs/heads/master' && 'production' || 'development' }}
    
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-noble
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Debug environment variables
        env:
          BASE_URL: ${{ vars.BASE_URL || 'https://www.saucedemo.com' }}
          PROFILE: ${{ vars.PROFILE || 'default' }}
          USERNAME: ${{ secrets.USERNAME || '' }}
          PASSWORD: ${{ secrets.PASSWORD || '' }}
          CI: true
        run: |
          echo "=== Environment Configuration ==="
          echo "BASE_URL: ${BASE_URL:-https://www.saucedemo.com}"
          echo "PROFILE: ${PROFILE:-default}"
          echo "USERNAME is set: $([ -n "$USERNAME" ] && echo 'âœ“ Yes' || echo 'âœ— No (will use default)')"
          echo "PASSWORD is set: $([ -n "$PASSWORD" ] && echo 'âœ“ Yes' || echo 'âœ— No (will use default)')"
          echo "CI: $CI"
          echo ""
          if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
            echo "âš ï¸  WARNING: USERNAME or PASSWORD not set in GitHub Secrets"
            echo "   Tests will use default credentials (standard_user/secret_sauce)"
            echo "   To use custom credentials, add USERNAME and PASSWORD as repository secrets"
          fi

      - name: Run Playwright UI tests
        env:
          BASE_URL: ${{ vars.BASE_URL || '' }}
          PROFILE: ${{ vars.PROFILE || 'default' }}
          USERNAME: ${{ secrets.USERNAME || '' }}
          PASSWORD: ${{ secrets.PASSWORD || '' }}
          CI: true
        run: npx playwright test --project=ui-tests

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright/report/
          retention-days: 30

      - name: Add test report link to job summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### View HTML Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact Download Link:**" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Playwright HTML Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Steps to view:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Click the link above to go to the workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Scroll down to the \`Artifacts\` section" >> $GITHUB_STEP_SUMMARY
          echo "3. Download \`playwright-report\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "4. Extract the ZIP file and open \`index.html\` in your browser" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Direct artifact URL format:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload test results (JUnit)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-results
          path: playwright/report/results.xml
          retention-days: 30

      - name: Upload test results (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: json-results
          path: playwright/report/results.json
          retention-days: 30
